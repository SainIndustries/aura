name: Provision Agent

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: 'Provisioning job ID'
        required: true
        type: string
      agent_id:
        description: 'Agent ID to provision'
        required: true
        type: string
      region:
        description: 'Deployment region (e.g. us-east, eu-central)'
        required: true
        type: string
      callback_url:
        description: 'URL to POST status callbacks to'
        required: true
        type: string

jobs:
  provision:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Send provisioning callback
        run: |
          BODY='{"job_id":"${{ inputs.job_id }}","status":"provisioning","workflow_run_id":"${{ github.run_id }}"}'
          SIGNATURE=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "${{ secrets.GITHUB_CALLBACK_SECRET }}" -hex | awk '{print $NF}')

          curl -sf -X POST "${{ inputs.callback_url }}" \
            -H "Content-Type: application/json" \
            -H "X-Signature: $SIGNATURE" \
            -d "$BODY"

          echo "Sent provisioning callback for job ${{ inputs.job_id }}"

      - name: Heartbeat loop
        run: |
          # Send heartbeats every 60 seconds in background
          while true; do
            sleep 60
            BODY='{"job_id":"${{ inputs.job_id }}","type":"heartbeat"}'
            SIGNATURE=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "${{ secrets.GITHUB_CALLBACK_SECRET }}" -hex | awk '{print $NF}')

            curl -sf -X POST "${{ inputs.callback_url }}" \
              -H "Content-Type: application/json" \
              -H "X-Signature: $SIGNATURE" \
              -d "$BODY" || true
          done &
          HEARTBEAT_PID=$!

          # Save PID for cleanup
          echo "$HEARTBEAT_PID" > /tmp/heartbeat_pid
          echo "Heartbeat loop started (PID: $HEARTBEAT_PID)"

      - name: Provision VM
        id: provision
        env:
          HETZNER_API_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
          HETZNER_SSH_KEY_ID: ${{ secrets.HETZNER_SSH_KEY_ID }}
          TAILSCALE_OAUTH_CLIENT_ID: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          TAILSCALE_OAUTH_CLIENT_SECRET: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          JOB_ID: ${{ inputs.job_id }}
          AGENT_ID: ${{ inputs.agent_id }}
          REGION: ${{ inputs.region }}
        run: npx tsx src/lib/provisioning/provision-vm.ts

      - name: Stop heartbeat
        if: always()
        run: |
          if [ -f /tmp/heartbeat_pid ]; then
            kill $(cat /tmp/heartbeat_pid) 2>/dev/null || true
            echo "Heartbeat loop stopped"
          fi

      - name: Send success callback
        if: success()
        run: |
          BODY=$(jq -n \
            --arg job_id "${{ inputs.job_id }}" \
            --arg status "running" \
            --arg server_id "${{ steps.provision.outputs.server_id }}" \
            --arg server_ip "${{ steps.provision.outputs.server_ip }}" \
            --arg tailscale_ip "${{ steps.provision.outputs.tailscale_ip }}" \
            '{job_id: $job_id, status: $status, server_id: $server_id, server_ip: $server_ip, tailscale_ip: $tailscale_ip}')
          SIGNATURE=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "${{ secrets.GITHUB_CALLBACK_SECRET }}" -hex | awk '{print $NF}')

          curl -sf -X POST "${{ inputs.callback_url }}" \
            -H "Content-Type: application/json" \
            -H "X-Signature: $SIGNATURE" \
            -d "$BODY"

          echo "Sent success callback with VM metadata for job ${{ inputs.job_id }}"

      - name: Send failure callback
        if: failure()
        run: |
          BODY=$(jq -n \
            --arg job_id "${{ inputs.job_id }}" \
            --arg status "failed" \
            --arg error "Provisioning workflow failed" \
            --arg failed_step "provision" \
            '{job_id: $job_id, status: $status, error: $error, failed_step: $failed_step}')
          SIGNATURE=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "${{ secrets.GITHUB_CALLBACK_SECRET }}" -hex | awk '{print $NF}')

          curl -sf -X POST "${{ inputs.callback_url }}" \
            -H "Content-Type: application/json" \
            -H "X-Signature: $SIGNATURE" \
            -d "$BODY"

          echo "Sent failure callback for job ${{ inputs.job_id }}"
