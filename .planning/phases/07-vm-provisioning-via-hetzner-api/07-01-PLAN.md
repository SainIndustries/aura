---
phase: 07-vm-provisioning-via-hetzner-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/hetzner.ts
  - src/lib/tailscale.ts
  - src/lib/cloud-init.ts
autonomous: true
user_setup:
  - service: hetzner
    why: "VM provisioning via Hetzner Cloud REST API"
    env_vars:
      - name: HETZNER_API_TOKEN
        source: "Hetzner Cloud Console -> Security -> API Tokens -> Generate API Token (Read & Write)"
    dashboard_config:
      - task: "Upload platform SSH public key"
        location: "Hetzner Cloud Console -> Security -> SSH Keys -> Add SSH Key"
  - service: tailscale
    why: "Tailscale networking with ephemeral auth keys"
    env_vars:
      - name: TAILSCALE_OAUTH_CLIENT_ID
        source: "Tailscale Admin Console -> Settings -> OAuth clients -> Generate OAuth client (with devices:write scope and tag:agent)"
      - name: TAILSCALE_OAUTH_CLIENT_SECRET
        source: "Same OAuth client creation page as above"
    dashboard_config:
      - task: "Create ACL tag 'tag:agent' in Tailscale policy"
        location: "Tailscale Admin Console -> Access Controls -> add tag:agent to tagOwners"

must_haves:
  truths:
    - "Hetzner API client can create a server with cloud-init user_data"
    - "Hetzner API client can poll action status until completion"
    - "Tailscale API client can generate ephemeral auth keys via OAuth"
    - "Tailscale API client can verify device enrollment by hostname"
    - "Cloud-init generator produces valid YAML with NTP sync and Tailscale install"
    - "All API clients handle rate limits and errors with exponential backoff"
  artifacts:
    - path: "src/lib/hetzner.ts"
      provides: "Hetzner Cloud REST API client"
      exports: ["createServer", "waitForAction", "deleteServer"]
      min_lines: 80
    - path: "src/lib/tailscale.ts"
      provides: "Tailscale API client with OAuth auth key generation"
      exports: ["getOAuthToken", "createAuthKey", "verifyEnrollment"]
      min_lines: 60
    - path: "src/lib/cloud-init.ts"
      provides: "Cloud-init YAML configuration generator"
      exports: ["generateCloudInitConfig"]
      min_lines: 20
  key_links:
    - from: "src/lib/cloud-init.ts"
      to: "src/lib/tailscale.ts"
      via: "Auth key interpolated into cloud-init template"
      pattern: "TAILSCALE_AUTH_KEY"
    - from: "src/lib/hetzner.ts"
      to: "https://api.hetzner.cloud/v1"
      via: "REST API calls with Bearer token"
      pattern: "api\\.hetzner\\.cloud"
    - from: "src/lib/tailscale.ts"
      to: "https://api.tailscale.com/api/v2"
      via: "REST API calls with OAuth token"
      pattern: "api\\.tailscale\\.com"
---

<objective>
Create Hetzner Cloud, Tailscale, and cloud-init TypeScript API client modules that encapsulate all external API interactions needed for VM provisioning.

Purpose: These modules provide the building blocks for the provisioning orchestrator (Plan 02). Each module is independently testable and reusable for lifecycle management (Phase 9). Using TypeScript over raw bash keeps logic testable and consistent with the codebase.

Output: Three new library modules -- `src/lib/hetzner.ts`, `src/lib/tailscale.ts`, `src/lib/cloud-init.ts`
</objective>

<execution_context>
@/Users/danielhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-vm-provisioning-via-hetzner-api/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hetzner Cloud API client module</name>
  <files>src/lib/hetzner.ts</files>
  <action>
Create `src/lib/hetzner.ts` with the following exports:

**Helper: `fetchWithRateLimit(url, options)`**
- Wraps native `fetch` with retry logic for HTTP 429 (rate limited)
- Reads `RateLimit-Reset` header to calculate wait time
- Falls back to exponential backoff with jitter (1s * 2^attempt, max 60s)
- Max 5 retries
- All non-429 errors propagate immediately
- Logs retry attempts with `[Hetzner]` prefix

**`createServer(config)`**
- Parameters: `{ name: string, serverType: string, image: string, location: string, sshKeys: number[], userData: string, labels: Record<string, string> }`
- POST to `https://api.hetzner.cloud/v1/servers`
- Headers: `Authorization: Bearer ${HETZNER_API_TOKEN}`, `Content-Type: application/json`
- Body: `{ name, server_type: config.serverType, image, location, ssh_keys: config.sshKeys, user_data: config.userData, start_after_create: true, labels }`
- Returns typed response: `{ server: { id: number, name: string, public_net: { ipv4: { ip: string } } }, action: { id: number, status: string } }`
- Throws on non-2xx with Hetzner error message parsed from `response.error.code` and `response.error.message`
- Uses `fetchWithRateLimit` for the request

**`waitForAction(actionId, options?)`**
- Parameters: `actionId: number`, optional `{ maxRetries?: number, intervalMs?: number }` (defaults: 120 retries, 1000ms interval as per research)
- GET `https://api.hetzner.cloud/v1/actions/${actionId}`
- Polls until `action.status === 'success'`
- Throws on `action.status === 'error'` with action error message
- Throws on timeout (max retries exceeded)
- Uses `fetchWithRateLimit` for each poll request
- Logs progress with `[Hetzner]` prefix

**`deleteServer(serverId)`**
- Parameters: `serverId: number`
- DELETE `https://api.hetzner.cloud/v1/servers/${serverId}`
- Returns void on success (200)
- Throws on non-2xx
- Used by Phase 9 lifecycle management and error recovery
- Uses `fetchWithRateLimit`

**`getHetznerConfig()`** (internal helper)
- Reads `HETZNER_API_TOKEN` from `process.env`
- Throws descriptive error if missing: "Missing HETZNER_API_TOKEN environment variable"
- Returns `{ token: string }`

**Type exports:**
- `CreateServerConfig` -- input type for createServer
- `CreateServerResponse` -- response type (server object + action)
- `HetznerAction` -- action status type

Use native `fetch` (Node.js 18+, no external dependencies). Follow existing codebase convention: console.log with `[Hetzner]` prefix for logging. Use `process.env` directly (not dotenv import, consistent with existing code like `src/lib/provisioning/github-actions.ts`).

Important from research:
- Use `location` property, NOT deprecated `datacenter` (removal after July 2026)
- user_data is sent as plain UTF-8 string, NOT base64-encoded
- Server creation response includes `action.id` for polling
- Rate limit: 3600 req/hour, poll at 1-second intervals
  </action>
  <verify>
`npx tsc --noEmit` passes with no new errors. Grep for exports: `createServer`, `waitForAction`, `deleteServer`, `fetchWithRateLimit` all present in file. File uses `api.hetzner.cloud` URL. File uses `location` (not `datacenter`) in createServer body.
  </verify>
  <done>
`src/lib/hetzner.ts` exports createServer, waitForAction, deleteServer, fetchWithRateLimit. All functions use proper Hetzner API v1 endpoints with Bearer auth, rate limit handling, and typed responses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Tailscale API client and cloud-init generator modules</name>
  <files>src/lib/tailscale.ts, src/lib/cloud-init.ts</files>
  <action>
**Create `src/lib/tailscale.ts`:**

**`getOAuthToken()`**
- POST to `https://api.tailscale.com/api/v2/oauth/token`
- Content-Type: `application/x-www-form-urlencoded`
- Body: `grant_type=client_credentials`, `client_id=${TAILSCALE_OAUTH_CLIENT_ID}`, `client_secret=${TAILSCALE_OAUTH_CLIENT_SECRET}`
- Returns `{ access_token: string }`
- Throws on non-2xx with response body

**`createAuthKey()`**
- Calls `getOAuthToken()` first to get access token
- POST to `https://api.tailscale.com/api/v2/tailnet/-/keys`
- Authorization: `Bearer ${access_token}`
- Body: `{ capabilities: { devices: { create: { reusable: false, ephemeral: true, preauthorized: true, tags: ["tag:agent"] } } }, expirySeconds: 3600 }`
- Returns `{ key: string }` -- the auth key string
- Throws on non-2xx

**`verifyEnrollment(hostname, options?)`**
- Parameters: `hostname: string`, optional `{ maxRetries?: number, intervalMs?: number }` (defaults: 60 retries, 2000ms as per research -- 30-60 sec expected enrollment time)
- Calls `getOAuthToken()` first
- GET `https://api.tailscale.com/api/v2/tailnet/-/devices`
- Polls until device with matching hostname appears AND has `addresses` array with at least one entry
- Returns `{ tailscaleIp: string, deviceId: string }` (addresses[0] is primary Tailscale IP)
- Throws on timeout: "Tailscale enrollment timeout for ${hostname}"
- Logs progress with `[Tailscale]` prefix

**`getTailscaleConfig()`** (internal helper)
- Reads `TAILSCALE_OAUTH_CLIENT_ID` and `TAILSCALE_OAUTH_CLIENT_SECRET` from `process.env`
- Throws descriptive error if either missing

**Type exports:**
- `TailscaleDevice` -- device object from API
- `TailscaleEnrollmentResult` -- { tailscaleIp, deviceId }

---

**Create `src/lib/cloud-init.ts`:**

**`generateCloudInitConfig(params)`**
- Parameters: `{ tailscaleAuthKey: string, hostname: string }`
- Returns a string containing the cloud-init YAML config
- Template (from research, with NTP sync pitfall fix):

```
#cloud-config
runcmd:
  - systemctl restart systemd-timesyncd
  - timeout 60 bash -c 'until timedatectl status | grep -q "System clock synchronized: yes"; do sleep 1; done'
  - curl -fsSL https://tailscale.com/install.sh | sh
  - tailscale up --auth-key=${tailscaleAuthKey} --advertise-tags=tag:agent --hostname=${hostname}
```

- Variables are interpolated directly into the YAML string (NOT left as shell variables)
- Returns the full YAML as a UTF-8 string (NOT base64-encoded, per Hetzner API)
- Keep under 32 KiB (this template is well under limit)

Both modules: Use native `fetch`, console.log with appropriate prefix (`[Tailscale]`, `[CloudInit]`), `process.env` for config. No external dependencies.
  </action>
  <verify>
`npx tsc --noEmit` passes with no new errors. Grep for exports: `getOAuthToken`, `createAuthKey`, `verifyEnrollment` in tailscale.ts. Grep for `generateCloudInitConfig` in cloud-init.ts. cloud-init.ts output contains `#cloud-config` and `systemctl restart systemd-timesyncd` (NTP sync fix). tailscale.ts uses `api.tailscale.com` URL.
  </verify>
  <done>
`src/lib/tailscale.ts` exports getOAuthToken, createAuthKey, verifyEnrollment with OAuth-based ephemeral key generation and device enrollment polling. `src/lib/cloud-init.ts` exports generateCloudInitConfig producing valid cloud-init YAML with NTP clock sync before Tailscale installation.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero new TypeScript errors
2. All three files exist: `src/lib/hetzner.ts`, `src/lib/tailscale.ts`, `src/lib/cloud-init.ts`
3. Hetzner module exports: createServer, waitForAction, deleteServer, fetchWithRateLimit
4. Tailscale module exports: getOAuthToken, createAuthKey, verifyEnrollment
5. Cloud-init module exports: generateCloudInitConfig
6. No external npm dependencies added (all use native fetch)
7. Rate limit handling present in hetzner.ts (HTTP 429 retry logic)
8. NTP sync present in cloud-init template (prevents SSL clock skew pitfall)
</verification>

<success_criteria>
Three independent, typed API client modules exist with proper error handling, rate limiting, and logging. Each module encapsulates one external service interaction. TypeScript compiles without errors. No new npm dependencies introduced.
</success_criteria>

<output>
After completion, create `.planning/phases/07-vm-provisioning-via-hetzner-api/07-01-SUMMARY.md`
</output>
