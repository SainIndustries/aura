---
phase: 09-lifecycle-management
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - .github/workflows/provision-agent.yml
autonomous: true

must_haves:
  truths:
    - "Provision workflow cleans up Hetzner VM on failure if server was created"
    - "Provision workflow sends server_id in failure callback for database-side rollback"
    - "Rollback step runs even when other steps fail (if: failure() + always() guard)"
    - "Failure callback includes server_id so the callback handler can trigger rollbackFailedProvision"
  artifacts:
    - path: ".github/workflows/provision-agent.yml"
      provides: "Rollback step for VM cleanup on provision failure"
      contains: "Rollback"
  key_links:
    - from: ".github/workflows/provision-agent.yml"
      to: "src/app/api/webhooks/github/route.ts"
      via: "failure callback with server_id triggers rollbackFailedProvision"
      pattern: "server_id"
---

<objective>
Add rollback logic to the provision-agent GitHub Actions workflow so that orphaned Hetzner VMs are cleaned up when provisioning fails after VM creation.

Purpose: Prevents orphaned VMs from accumulating costs when provisioning fails mid-workflow (e.g., Ansible fails after VM is created). The failure callback already triggers rollbackFailedProvision (Plan 02), but the workflow should also include server_id in the failure payload so the callback handler has the metadata needed for cleanup.
Output: Updated provision-agent.yml with server_id in failure callback
</objective>

<execution_context>
@/Users/danielhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-lifecycle-management/09-RESEARCH.md
@.planning/phases/09-lifecycle-management/09-01-SUMMARY.md
@.github/workflows/provision-agent.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add server_id to failure callback and add workflow-level rollback step</name>
  <files>.github/workflows/provision-agent.yml</files>
  <action>
Modify `.github/workflows/provision-agent.yml` to ensure orphaned VMs are cleaned up when provisioning fails.

**Change 1: Include server_id in failure callback payload**

The existing "Send failure callback" step constructs a JSON body but does NOT include server_id. The callback handler (Plan 02) uses server_id to look up the agent instance and trigger rollbackFailedProvision. Update the failure callback to include server_id from the provision step outputs:

Replace the failure callback BODY construction with:
```bash
BODY=$(jq -n \
  --arg job_id "${{ inputs.job_id }}" \
  --arg status "failed" \
  --arg error "Provisioning workflow failed at $FAILED_STEP" \
  --arg failed_step "$FAILED_STEP" \
  --arg server_id "${{ steps.provision.outputs.server_id }}" \
  --arg server_ip "${{ steps.provision.outputs.server_ip }}" \
  --arg tailscale_ip "${{ steps.provision.outputs.tailscale_ip }}" \
  '{job_id: $job_id, status: $status, error: $error, failed_step: $failed_step, server_id: $server_id, server_ip: $server_ip, tailscale_ip: $tailscale_ip}')
```

The server_id, server_ip, and tailscale_ip may be empty strings if the provision step itself failed before creating the VM. That's fine - the rollbackFailedProvision function in lifecycle.ts checks if serverId exists before attempting cleanup.

**Change 2: Add Hetzner VM cleanup step**

Add a new step between "Cleanup SSH key" and "Send success callback" (or rather, make it run on failure). Add this step BEFORE the failure callback step, with `if: failure()`:

```yaml
      - name: Cleanup orphaned VM on failure
        if: failure() && steps.provision.outputs.server_id != ''
        env:
          HETZNER_API_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
        run: |
          echo "Attempting to delete orphaned Hetzner server ${{ steps.provision.outputs.server_id }}"
          SERVER_ID="${{ steps.provision.outputs.server_id }}"

          # Delete Hetzner server (idempotent - 404 is OK)
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X DELETE "https://api.hetzner.cloud/v1/servers/${SERVER_ID}" \
            -H "Authorization: Bearer ${HETZNER_API_TOKEN}")

          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "404" ]; then
            echo "Hetzner server ${SERVER_ID} cleanup successful (HTTP ${HTTP_STATUS})"
          else
            echo "WARNING: Hetzner server ${SERVER_ID} cleanup returned HTTP ${HTTP_STATUS}"
          fi
```

This provides a first line of defense for VM cleanup directly in the workflow. The callback handler's rollbackFailedProvision provides a second layer (also handles Tailscale device cleanup via the API).

**Important:** Do NOT change the step ordering of existing steps. The new "Cleanup orphaned VM" step should be inserted right after "Cleanup SSH key" and before "Send success callback". The `if: failure()` condition ensures it only runs when earlier steps fail. The `steps.provision.outputs.server_id != ''` guard ensures it only runs when a VM was actually created.
  </action>
  <verify>Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/provision-agent.yml'))"` should succeed. Verify failure callback includes server_id: `grep "server_id" .github/workflows/provision-agent.yml | wc -l` should be at least 4 (success callback + failure callback + cleanup step condition + cleanup step body). Verify cleanup step exists: `grep "Cleanup orphaned VM" .github/workflows/provision-agent.yml`.</verify>
  <done>Provision workflow sends server_id in failure callback for database-side rollback. Workflow also directly attempts Hetzner VM deletion on failure as first-line defense. Both mechanisms are idempotent (404 = success).</done>
</task>

</tasks>

<verification>
1. YAML syntax is valid (python yaml.safe_load)
2. Failure callback includes server_id, server_ip, tailscale_ip
3. Cleanup step has proper `if: failure()` guard
4. Cleanup step checks server_id is non-empty before attempting deletion
5. Cleanup uses idempotent deletion (treats 404 as success)
6. Existing workflow steps are unchanged (provision, configure, heartbeat, success callback)
</verification>

<success_criteria>
Provision workflow automatically cleans up orphaned Hetzner VMs on failure. Failure callback includes VM metadata for database-side rollback. Both cleanup mechanisms are idempotent and best-effort (don't fail the workflow further).
</success_criteria>

<output>
After completion, create `.planning/phases/09-lifecycle-management/09-03-SUMMARY.md`
</output>
